(()=>{"use strict";var e={d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>$});const s={};wx.getLogManager({level:1}),s.info=(...e)=>{},s.warn=(...e)=>{},s.error=(...e)=>{},s.debug=(...e)=>{};const n=s;class i{constructor(){this.prefix="",this.tag=""}addPrefix(e){return this.prefix+=e+":",this.tag=this.prefix,this}addKeys(e){if(!e||!Array.isArray(e))return this;const t=this;return e.forEach((e=>{Object.defineProperty(this,e,{get:()=>(t.tag=`${t.prefix} ${e} >>> `,t)})})),this}info(...e){n.info(this.tag,...e)}warn(...e){n.warn(this.tag,...e)}debug(...e){n.debug(this.tag,...e)}error(...e){n.error(this.tag,...e)}}const o=(new i).addPrefix("Meeting").addKeys(["state","member","infom","options","operation","reconnect"]),r=(new i).addPrefix("Login").addKeys(["auth","register","agreement"]),a=(new i).addPrefix("Network").addKeys(["socket","http"]),c=(new i).addPrefix("system").addKeys(["event","system"]),d=o,h="MEETING_END_BY_SERVER",p=e=>{const t=[];for(let e=0;e<36;e++)t[e]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);t[8]=t[13]=t[18]=t[23]="-";const s=t.join("");return e?s.replace(/-/g,""):s};function u(e){let t="";for(const s in e)t+=`${s}=${e[s]}&`;return t.slice(0,-1)}Error;const m="_ML_DEVICE_ID",l=new class{constructor(){this.state={serverUrl:"",clientHeader:"MDIyNTY0NWMtMjAyZC00ZGIwLTgyNGEtZTY4ZDYxZDcwMzJkOjhrWHBjUkF1SXdYN1J5Vnk=",clientToken:"",systemInfo:{system:"unknow"},deviceId:""}}async init(e){this.state.serverUrl=e.serverUrl,await this.getSystemInfo(),this.state.deviceId=await this.getDeviceId()}getDeviceId(){let e=wx.getStorageSync(m);return e||(e=p(),wx.setStorageSync(m,e)),e}getSystemInfo(){return new Promise((e=>{try{wx.getSystemInfoAsync({success:e=>{this.state.systemInfo.system=e.system},fail:e=>{c.system.warn("wx.getSystemInfoAsync fail",e)},complete(){e(!0)}})}catch(t){c.system.warn("wx not support [getSystemInfoAsync] api"),e(!0)}}))}get clientToken(){return this.state.clientToken}get clientHeader(){return this.state.clientHeader}get passportUrl(){return`${this.state.serverUrl}/passport`}get rscUrl(){return`${this.state.serverUrl}/rsc`}get meetingUrl(){return`${this.state.serverUrl}/meeting`}get eimsUrl(){return`${this.state.serverUrl}/eims`}get uimsUrl(){return`${this.state.serverUrl}/uims`}},g=new class{constructor(){this.state={sessionId:"",endpointId:""}}},E=new class{constructor(){this.state={userToken:"",userInfo:{userId:"",displayName:"",realName:"",avatar:"",mobile:""}}}saveUserToken(e){this.state.userToken=e}get userToken(){return this.state.userToken}},I=new class{constructor(){this.system=l,this.user=E,this.meeting=g}async init(e){return await this.system.init(e),this}};var f;!function(e){e.beforeSend="beforeSend",e.onRequestError="onRequestError",e.onNetworkError="onNetworkError",e.onTimeout="onTimeout",e.onSuccess="onSuccess"}(f||(f={}));const y={BEFORE_SEND:f.beforeSend,REQUEST_ERROR:f.onRequestError,NETWORK_ERROR:f.onNetworkError,TIMEOUT:f.onTimeout,SUCCESS:f.onSuccess},v={[y.BEFORE_SEND]:"beforeSendBook",[y.REQUEST_ERROR]:"onRequestErrorBook",[y.NETWORK_ERROR]:"onNetworkErrorBook",[y.TIMEOUT]:"onTimeoutBook",[y.SUCCESS]:"onSuccessBook"};var T;!function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE"}(T||(T={}));const M=(e,t)=>({baseUrl:e,apis:{getClientToken:{method:T.POST,path:"/api/token?grant_type=client_credentials",beforeSend(e){t.setfetchClientIdHeader(e)}},getUserToken:{method:T.POST,path:"/api/token?grant_type=wechat_applet",beforeSend(e){t.setClientTokenHeader(e)}},bindWechatAccount:{method:T.POST,path:"/api/v1/third-party-accounts/wechat-applet/actions/bind-account",beforeSend(e){t.setClientTokenHeader(e)}}}}),k=(e,t)=>({baseUrl:e,beforeSend(e){t.setAccessTokenHeader(e)},apis:{joinMeeting:{method:T.POST,path:"/api/v2/user/sessions/actions/join"},getMeetingInfo:{method:T.GET,path:"/api/v2/user/sessions/:sessionId",beforeSend(e){t.setOperator(e),t.setEndpointIdHeader(e)}},getMemberList:{method:T.GET,path:"/api/v2/user/sessions/:sessionId/endpoints",beforeSend(e){t.setEndpointIdHeader(e)}},muteMember:{method:T.POST,path:"/api/v1/user/sessions/:sessionId/endpoints/:endpointId/actions/mute",beforeSend(e){t.setEndpointIdHeader(e)}},unmuteMember:{method:T.POST,path:"/api/v1/user/sessions/:sessionId/endpoints/:endpointId/actions/unmute",beforeSend(e){t.setEndpointIdHeader(e)}},turnVideoOff:{method:T.POST,path:"/api/v1/user/sessions/:sessionId/endpoints/:endpointId/actions/turn-video-off",beforeSend(e){t.setEndpointIdHeader(e)}},turnVideoOn:{method:T.POST,path:"/api/v1/user/sessions/:sessionId/endpoints/:endpointId/actions/turn-video-on",beforeSend(e){t.setEndpointIdHeader(e)}},observeVideo:{method:T.POST,path:"/api/v1/user/sessions/:sessionId/endpoints/:endpointId/mlb/videos",beforeSend(e){t.setEndpointIdHeader(e)}},unobserveVideo:{method:T.DELETE,path:"/api/v1/user/sessions/:sessionId/endpoints/:endpointId/mlb/videos",beforeSend(e){t.setEndpointIdHeader(e)}},getVideoPullUrl:{method:T.POST,path:"/api/v2/user/sessions/:sessionId/media/video-stream/subscribe-url/actions/batch-get",beforeSend(e){t.setEndpointIdHeader(e)}},getSipsInfo:{method:T.GET,path:"/api/media/third-party-gateway"},rejectUnmute:{method:T.POST,path:"/api/v1/user/sessions/:sessionId/endpoints/:endpointId/actions/reject-unmute",beforeSend(e){t.setEndpointIdHeader(e)}},leaveMeeting:{method:T.DELETE,path:"/api/v1/user/sessions/:sessionId/endpoints/:endpointId",beforeSend(e){t.setEndpointIdHeader(e)}},handDown:{method:T.DELETE,path:"/api/v1/user/sessions/:sessionId/endpoints/:endpointId/speak-request",beforeSend(e){t.setEndpointIdHeader(e)}},handUp:{method:T.POST,path:"/api/v1/user/sessions/:sessionId/endpoints/:endpointId/speak-request",beforeSend(e){t.setEndpointIdHeader(e)}},rejectUnmuteVideo:{method:T.POST,path:"/api/v1/user/sessions/:sessionId/endpoints/actions/reject-turn-on-video",beforeSend(e){t.setEndpointIdHeader(e)}},modifyMemberName:{method:T.POST,path:"/api/v2/user/sessions/:sessionId/endpoints/:endpointId/nickname",beforeSend(e){t.setEndpointIdHeader(e)}}}}),w=(e,t)=>({baseUrl:e,apis:{getShareUrl:{method:T.POST,path:"/api/identities/link"},getParamsByPayloadId:{method:T.GET,path:"/api/identities/:identityId/payload"}},beforeSend(e){t.setAccessTokenHeader(e)}}),O=(e,t)=>({baseUrl:e,beforeSend(e){t.setAccessTokenHeader(e)},apis:{getUserInfo:{method:T.GET,path:"/api/user/staffs/current/details"},createCompany:{method:T.POST,path:"/api/user/companies"}}}),S=(e,t)=>({baseUrl:e,beforeSend(e){t.setAccessTokenHeader(e)},apis:{updateUserInfo:{method:T.POST,path:"/api/v2/user/action/patch"}}});class _{}class b extends _{constructor(e){super(),this.model=e.model,this.http=e.http}async turnOnMicrophone(){const{endpointId:e,sessionId:t}=this.model.meeting.state;return await this.http.unmuteMember({sessionId:t,endpointId:e})}async turnOffMicrophone(){const{endpointId:e,sessionId:t}=this.model.meeting.state;return await this.http.muteMember({sessionId:t,endpointId:e})}async rejectTurnOnMicrophone(){const{sessionId:e,endpointId:t}=this.model.meeting.state;return await this.http.rejectUnmute({sessionId:e,endpointId:t})}}class C extends _{constructor(e){super(),this.model=e.model,this.http=e.http}async joinMeeting(e){const{code:t,password:s,turnOnCamera:n,turnOnMicrophone:i,name:o,avatar:r}=e,{realName:a,displayName:c,avatar:d}=this.model.user.state.userInfo,h={mediaOpts:{sdp:"wechat-applet",isAudioMute:!i,isVideoMute:!n},endpointInfo:{nickname:o||a||c,headImage:r||d,deviceSn:this.model.system.state.deviceId,platform:7,isFastRecovery:!1},sessionInfo:{code:t,password:s}},p=await this.http.joinMeeting(h),{endpoint:{id:u},session:{id:m}}=p;return this.model.meeting.state.endpointId=u,this.model.meeting.state.sessionId=m,p}async quitMeeting(){const{endpointId:e,sessionId:t}=this.model.meeting.state;if(t&&e)return await this.http.leaveMeeting({endpointId:e,sessionId:t})}async getMeetingInfo(){const{sessionId:e}=this.model.meeting.state;return await this.http.getMeetingInfo({sessionId:e})}}const U={1:"ORGANIZER",2:"HOST",3:"MEMBER"};class R extends _{constructor(e){super(),this.model=e.model,this.http=e.http}async getMeetingList(e={size:9999}){const{sessionId:t}=this.model.meeting.state,s=await this.http.getMemberList({sessionId:t,size:e.size}),n=s.data.map((e=>Object.assign(Object.assign({},e),{endpointId:e.id,roleType:U[e.role.type]})));return s.data=n,s}}var N;!function(e){e.Media="meeting_media_v1",e.Confservice="meeting_confservice_v1",e.Meeting="meeting_meeting_v1"}(N||(N={}));class P extends _{constructor(e){super(),this.model=e.model,this.eventManager=new A(e.eventCenter),this.eventManager.model=e.model,this.eventManager.service=this,this.init()}init(){wx.onNetworkStatusChange((e=>{const t=e.isConnected;a.socket.info(`network change: 网络${t?"正常":"异常"}, ${e.networkType}`),!t&&this.io&&(this.closeMeetingSocket(),console.log("emit disconnect event by networkStatusChange"),this.eventManager.eventCenter.emit(q,{key:j.DISCONNECT,data:null}))}))}async closeMeetingSocket(){try{const e=this.io;this.io=null,this.eventManager.io=null,e&&await e.close()}catch(e){a.socket.warn(e)}}async connectMeetingSocket(){const{endpointId:e,sessionId:t}=this.model.meeting.state,{serverUrl:s}=this.model.system.state,{userToken:n,userInfo:{userId:i}}=this.model.user.state,o=s.replace(/(http|https):\/\//,(e=>"https://"===e?"wss://":"ws://")),r=[N.Media,N.Confservice,N.Meeting],c={endpointId:e,accessToken:n,rooms:t},d={accessToken:n,endpointId:`applet/${i}`},h={endpointId:`applet/${i}`,accessToken:n},p={[N.Media]:c,[N.Confservice]:c,[N.Meeting]:h};try{const e=await(async e=>{const t=new class{constructor(e){this.retryTime=0,this.messageFunc=[],this.openFunc=[],this.errorFunc=[],this.closeFunc=[],this.reconnectFunc=[],this.reconnectingFunc=[],this.reconnectFailFunc=[];const{maxRetryTimes:t,connectRetryTime:s}=e;this.options=e,this.connectRetryTime=s||5e3,this.maxRetryTimes=t||10}async close(){this.socket&&await this.socket.destory()}async connect(e){const t=new class{constructor(e){this.queryStringObj={},this.onMessage=e=>{this.socketInstance&&this.socketInstance.onMessage((t=>{const s=this.generateMessage(t);s&&"object"==typeof s?(this.socketInstance&&this.socketInstance.send({data:s.id+"[]"}),e(s.data)):s&&(this.socketInstance&&this.socketInstance.send({data:s+"[]"}),e(s))}))};const{baseUrl:t,namespace:s,query:n,baseQuery:i,pingInterval:o}=e;this.baseQueryString=u(Object.assign(Object.assign({},i),{EIO:3,transport:"websocket"})),Object.keys(n).forEach((e=>{this.queryStringObj[e]=u(Object.assign(Object.assign({},n[e]),{EIO:3,transport:"websocket"}))})),this.url=`${t}/socket.io/?${this.baseQueryString}`,this.namespace=s,this.socketConfig={pingInterval:o||25e3}}async connect(){const e=await wx.connectSocket({url:this.url});return a.socket.info("connect socket success url",this.url),this.socketInstance=e,e.onError((()=>{clearInterval(this.socketPingPong)})),e.onClose((()=>{clearInterval(this.socketPingPong)})),e.onMessage((t=>{const{namespace:s,queryStringObj:n,socketConfig:i}=this;if("string"==typeof t.data){if("40"===t.data)s.forEach((t=>{e.send({data:`40/${t}?${n[t]}`})}));else if("0{"===t.data.slice(0,2)){try{this.socketConfig=JSON.parse(t.data.slice(1))}catch(e){a.socket.error(e)}this.socketPingPong=setInterval((()=>{e.send({data:"2"})}),i.pingInterval)}}else a.socket.warn("receive unknow socket message",t.data)})),e}generateMessage(e){if("string"==typeof e.data&&"42"===e.data.slice(0,2))try{const t=`(${this.namespace.join("|")})`,s=new RegExp(`^42/${t},[0-9]+`),n=e.data.replace(s,""),i=e.data.match(s);return{id:i&&i[0],data:JSON.parse(n)}}catch(t){return a.socket.error(t),e.data}}send(e){var t;null===(t=this.socketInstance)||void 0===t||t.send({data:e})}destory(){return new Promise(((e,t)=>{var s;this.socketInstance?(null===(s=this.socketInstance)||void 0===s||s.close({success:()=>{e(1)},fail(e){t(e)}}),this.socketInstance=null):e(1)}))}onClose(e){this.socketInstance&&this.socketInstance.onClose(e)}onOpen(e){this.socketInstance&&this.socketInstance.onOpen(e)}onError(e){this.socketInstance&&this.socketInstance.onError(e)}}(this.options);return this.socket=t,await t.connect(),this.registerReconnect(e),this.socket.onClose((e=>{this.closeFunc.map((t=>t(e)))})),this.socket.onOpen((e=>{this.openFunc.map((t=>t(e)))})),this.socket.onError((e=>{this.errorFunc.map((t=>t(e)))})),this.socket.onMessage((e=>{this.messageFunc.map((t=>t(e)))})),this}async registerReconnect(e){e||this.socket.onClose((e=>{1e3===e.code&&"interrupted"!==e.reason||this.reconnectFailFunc.map((t=>t(e)))}))}async delay(e){return new Promise((t=>{setTimeout((()=>{t(!0)}),e)}))}onError(e){this.errorFunc.push(e)}onOpen(e){this.openFunc.push(e)}onClose(e){this.closeFunc.push(e)}onMessage(e){this.messageFunc.push(e)}onReconnecting(e){this.reconnectingFunc.push(e)}onReconnectFail(e){this.reconnectFailFunc.push(e)}onReconnect(e){this.reconnectFunc.push(e)}async checkSocketHealth(){try{const e=await wx.sendSocketMessage({data:"2"});return a.socket.info(`socket check health result, [${e}]`),!0}catch(e){return a.socket.warn("socket unhealth",e),!1}}send(e){this.socket.send(e)}}(e),s=await t.connect();return s.onClose((e=>{a.socket.info("socket close",e)})),s.onError((e=>{a.socket.error("socket error",e)})),s.onOpen((e=>{a.socket.info("socket open",e)})),s})({baseUrl:o,namespace:r,query:p,baseQuery:d});this.io=e,this.eventManager.io=e,this.eventManager.registerSocketEvent()}catch(e){throw a.socket.error("socket connect error",e),e}}}class A{constructor(e){this.eventCenter=e}registerSocketEvent(){var e,t,s,n;null===(e=this.io)||void 0===e||e.onMessage((e=>{const t=e[0];if(this[t]&&"function"==typeof this[t]){const s=e[1].body;a.socket.info("receive socket",t,s),this[t](s)}})),null===(t=this.io)||void 0===t||t.onOpen((()=>{this.eventCenter.emit("SOCKET_OPEN")})),null===(s=this.io)||void 0===s||s.onReconnectFail((()=>{this.eventCenter.emit(q,{key:j.DISCONNECT,data:null}),this.io=null,this.service.io=null})),null===(n=this.io)||void 0===n||n.onClose((()=>{}))}"meeting.confservice.room.change_view"(e){this.eventCenter.emit(q,{key:j.MODE_UPDATE,data:e})}"meeting.confservice.room.close"(e){this.eventCenter.emit(q,{key:j.MEETING_END,data:e})}"meeting.confservice.session.close"(e){this.eventCenter.emit(q,{key:j.MEETING_END,data:e})}"meeting.confservice.roomendpoint.turn_video_off"(e){this.eventCenter.emit(q,{key:j.MEMBER_UPDATE,data:{endpointId:e.roomEndpointId,isVideoMute:!0},operator:e.operator})}"meeting.confservice.roomendpoint.turn_video_on"(e){this.eventCenter.emit(q,{key:j.MEMBER_UPDATE,data:{endpointId:e.roomEndpointId,isVideoMute:!1},operator:e.operator})}"meeting.confservice.endpoint.request_turn_on_video"(){this.eventCenter.emit(q,{key:j.REQUEST_TURN_ON_CAMERA,data:null})}"meeting.confservice.roomendpoint.disconnect"(e){this.eventCenter.emit(q,{key:j.MEMBER_QUIT,data:{endpointId:e.roomEndpointId}})}"meeting.confservice.roomendpoint.kick_out"(){this.eventCenter.emit(q,{key:j.KICK_OUT,data:null}),setTimeout((()=>{this.eventCenter.off(q,null,!0)}))}"meeting.confservice.roomendpoint.recovering"(){this.eventCenter.emit(q,{key:j.DISCONNECT,data:null})}"meeting.confservice.session.main_venue_update"(e){this.eventCenter.emit(q,{key:j.MAIN_VENUE_UPDATE,data:e})}"meeting.confservice.room.join"(e){const{roomEndpointId:t,userId:s,options:n,lastJoinTime:i,nickname:o,role:r,headImage:a}=e,c={endpointId:t,nickname:o,userId:s,headImage:a,isAudioMute:n.isMute,isVideoMute:n.isVideoOff,lastJoinTime:i,roleType:U[r.type]};this.eventCenter.emit(q,{key:j.MEMBER_JOIN,data:c})}"meeting.confservice.roomendpoint.quit_room"(e){this.eventCenter.emit(q,{key:j.MEMBER_QUIT,data:{endpointId:e.roomEndpointId}})}"meeting.confservice.roomendpoint.mute_all"(e){this.eventCenter.emit(q,{key:j.MUTE_ALL,data:e})}"meeting.confservice.roomendpoint.mute"(e){this.eventCenter.emit(q,{key:j.MEMBER_UPDATE,data:{endpointId:e.roomEndpointId,isAudioMute:!0},operator:e.operator})}"meeting.confservice.roomendpoint.unmute"(e){this.eventCenter.emit(q,{key:j.MEMBER_UPDATE,data:{endpointId:e.roomEndpointId,isAudioMute:!1},operator:e.operator})}"meeting.confservice.session.options_changed"(e){this.eventCenter.emit(q,{key:j.OPTIONS_CHANGED,data:e.options})}"meeting.confservice.media.request_unmute"(){this.eventCenter.emit(q,{key:j.REQUEST_TURN_ON_MICROPHONE,data:null})}"meeting.confservice.role.changed"(e){for(const t in e)this.eventCenter.emit(q,{key:j.MEMBER_UPDATE,data:{endpointId:e[t].endpointId,roleType:U[e[t].type]}})}"meeting.confservice.virtual_room.update"(e){this.eventCenter.emit(q,{key:j.MEETING_INFO_UPDATE,data:e})}"meeting.media.endpoint.video.active"(e){const t=this.model.meeting.state.endpointId;if(e.endpointIds&&e.endpointIds[0]){const s=e.endpointIds.find((e=>e!==t));s&&this.eventCenter.emit(q,{key:j.ACTIVE_MEMBER_UPDATE,data:s||e.endpointIds[0]})}}}var D,x,j;!function(e){e[e.ACTIVE_DESKTOP=0]="ACTIVE_DESKTOP",e[e.SUBSCRIPTION=1]="SUBSCRIPTION"}(D||(D={})),function(e){e[e.MIN=360]="MIN",e[e.NORMAL=360]="NORMAL",e[e.HIGH=1080]="HIGH"}(x||(x={}));class B extends _{constructor(e){super(),this.model=e.model,this.http=e.http}async getVideoPullUrl(e){const{sessionId:t,endpointId:s}=this.model.meeting.state,{endpointId:n,isPresenter:i}=e,o=[{quality:i?x.HIGH:x.MIN,policy:i?"ActiveDesktop":"Subscription",UUID:i?void 0:n}];o.sessionId=t,o.endpointId=s,d.member.debug("begin get video pull url",o);const r=await this.http.getVideoPullUrl(o);r&&r[0]||d.member.error("get empty video pull url",r);const a=r&&r[0]&&r[0].pullURL;return d.infom.info("get video pull url success "+(i?"isPresent":""),a),{pullUrl:a}}async observeMember(e){const{isPresenter:t,endpointId:s,pullUrl:n}=e,{endpointId:i,sessionId:o}=this.model.meeting.state,r=[{wechatURL:n,policy:t?"ActiveDesktop":"Subscription",UUID:s,quality:t?x.HIGH:x.NORMAL}];return r.endpointId=i,r.sessionId=o,await this.http.observeVideo(r)}async unobserveMember(e){const{endpointId:t,pullUrl:s}=e,{sessionId:n}=this.model.meeting.state;return await this.http.unobserveVideo({endpointId:t,sessionId:n,pullURL:s})}}class H extends _{constructor(e){super(),this.model=e.model,this.http=e.http}async init(){const{access_token:e}=await this.http.getClientToken({state:"xyz"});this.model.system.state.clientToken=e}}class L extends _{constructor(e){super(),this.http=e.http,this.model=e.model}async registerByPhoneCode(e){const{code:t,encryptedData:s,iv:n}=e,{access_token:i}=await this.http.bindWechatAccount({code:t,encryptedData:s,iv:n},{header:{"x-useragreement-version":1,"x-privacy-version":1}});return this.model.user.state.userToken=i,await this.getUserInfo()}async login(){const e=await this.wxLogin();if("login:ok"===e.errMsg){const{access_token:t}=await this.http.getUserToken({code:e.code});return this.model.user.state.userToken=t,await this.getUserInfo()}}async getUserInfo(){const e=await this.http.getUserInfo(),t=e.company||{};let s="",n="";return t?(s=t.avatar||e.avatar||"",n=t.mobile||e.mobile||""):(s=e.avatar||"",n=e.mobile||""),this.model.user.state.userInfo={displayName:e.displayName||"",realName:t.realName||"",userId:e.userId,avatar:s,mobile:n},this.model.user.state.userInfo}async wxLogin(){return new Promise(((e,t)=>{wx.login({success(t){r.auth.info("wxLogin success",t),e(t)},fail:e=>{r.auth.error("wxLogin fail",e),t(e)}})}))}}class V extends _{constructor(e){super(),this.model=e.model,this.http=e.http}async turnOnCamera(){const{sessionId:e,endpointId:t}=this.model.meeting.state;return await this.http.turnVideoOn({sessionId:e,endpointId:t})}async turnOffCamera(){const{sessionId:e,endpointId:t}=this.model.meeting.state;return await this.http.turnVideoOff({sessionId:e,endpointId:t})}async rejectTurnOnCamera(){const{sessionId:e}=this.model.meeting.state;return await this.http.rejectUnmuteVideo({sessionId:e})}}class F{constructor(){this.eventMap={}}on(e,t){this.eventMap[e]?this.eventMap[e].push(t):this.eventMap[e]=[t]}off(e,t,s=!1){const n=this.eventMap[e];if(!n)return void c.event.info(e,"event no register yet");s&&delete this.eventMap[e];const i=n.findIndex((e=>t===e));-1!==i?n.splice(i,1):c.event.info(e,t&&t.name,"handler no register yet")}emit(e,...t){const s=this.eventMap[e];s?s.forEach((e=>e(...t))):c.event.info(e,"event no register yet")}}!function(e){e.MEMBER_UPDATE="MEMBER_UPDATE",e.MEMBER_QUIT="MEMBER_QUIT",e.MEMBER_JOIN="MEMBER_JOIN",e.MUTE_ALL="MUTE_ALL",e.REQUEST_TURN_ON_CAMERA="REQUEST_TURN_ON_CAMERA",e.REQUEST_TURN_ON_MICROPHONE="REQUEST_TURN_ON_MICROPHONE",e.MEETING_INFO_UPDATE="MEETING_INFO_UPDATE",e.MODE_UPDATE="MODE_UPDATE",e.MEETING_END="MEETING_END",e.KICK_OUT="KICK_OUT",e.MEDIA_SERVER_ERROR="MEDIA_SERVER_ERROR",e.DISCONNECT="DISCONNECT",e.MAIN_VENUE_UPDATE="MAIN_VENUE_UPDATE",e.ACTIVE_MEMBER_UPDATE="ACTIVE_MEMBER_UPDATE",e.OPTIONS_CHANGED="OPTIONS_CHANGED"}(j||(j={}));const q="MEETING_EVENT",$=new class{async init(e){await I.init({serverUrl:e.serverUrl}),this.eventCenter=new F;const t=((e,t)=>{const s=((e,t)=>{const{system:s,meeting:n,user:i}=e,{passportUrl:o,rscUrl:r,meetingUrl:c,clientHeader:d,eimsUrl:u,uimsUrl:m}=s,l={setfetchClientIdHeader:e=>{e.header=Object.assign(e.header||{},{Authorization:`Basic ${d}`})},setClientTokenHeader:t=>{t.header=Object.assign(t.header||{},{Authorization:`Bearer ${e.system.clientToken}`})},setAccessTokenHeader:e=>{e.header=Object.assign(e.header||{},{Authorization:`Bearer ${i.userToken}`})},setEndpointIdHeader:e=>{e&&e.header&&!e.header["x-endpoint-id"]&&(e.header=Object.assign(e.header||{},{"x-endpoint-id":n.state.endpointId}))},setOperator:e=>{e.header=Object.assign(e.header||{},{operator:n.state.endpointId})}};return{timeout:15e3,isSendTraceId:!0,beforeSend(e){try{const t={"x-platform-type":"applet","x-os-type":s.state.systemInfo.system.split(" ")[0].toLocaleLowerCase(),"x-device-info":"applet","x-client-ver":"1.0.0","x-nonce":p(!0),"x-timestamp":+new Date};e.header=Object.assign(e.header,t)}catch(e){a.http.error(e)}},onTimeout(e,t,s){a.http.error(`${e&&e.url}, timeout`,s&&s.data,`traceId: ${e&&e.header["x-APM-TraceId"]}`,t)},onSuccess(e,t,s){a.http.debug(`${e.url}, http get result:`,s.data,`traceId: ${e.header["x-APM-TraceId"]}`)},onRequestError(e,s){a.http.warn(`url: ${e.method} ${e.url}`,"header:",e.header,"body: ","get"!==e.method?e.data:"","response:",s.data),!s.data||404111007!==s.data.code&&404111003!==s.data.code||t.emit(h)},apiList:[M(o,l),k(r,l),w(c,l),O(u,l),S(m,l)]}})(e,this.eventCenter);return new class{constructor(e){this.options=e,this.lifecycle=new class{constructor(e){this.beforeSendBook={},this.onRequestErrorBook={},this.onNetworkErrorBook={},this.onTimeoutBook={},this.onSuccessBook={};const{beforeSend:t,onRequestError:s,onTimeout:n,onNetworkError:i,onSuccess:o}=e;this.beforeSend=t,this.onRequestError=s,this.onTimeout=n,this.onNetworkError=i,this.onSuccess=o,this.initLifecycleBook(e,y.BEFORE_SEND),this.initLifecycleBook(e,y.REQUEST_ERROR),this.initLifecycleBook(e,y.NETWORK_ERROR),this.initLifecycleBook(e,y.TIMEOUT),this.initLifecycleBook(e,y.SUCCESS)}initLifecycleBook(e,t){const s=e[t]||(()=>{}),n={};e.apiList.forEach((e=>{const i=[s];let o=!1;e[t]&&(i.push(e[t]),o=!0);for(const s in e.apis){const r=e.apis[s][t],a=[...i];r&&(a.push(r),o=!0),o&&(n[s]=a)}})),this[v[t]]=n}triggerLifecycle({type:e,name:t,params:s,error:n,result:i}){if(!t)return;const o=this[v[e]][t];o?o.forEach((e=>{e&&e(s,n,i)})):"function"==typeof this[e]&&this[e](s,n,i)}}(e),this.request=new class{constructor(e){this.timeout=e.timeout}send(e){return e=this.generateConfig(e),new Promise(((t,s)=>{wx.request(Object.assign(Object.assign({},e),{success(e){t(e)},fail(e){s(e)}}))}))}generateConfig(e){return e.method=e.method.toUpperCase(),e.url=((e,t)=>{if(!t||0===Object.keys(t).length)return e;const s=e.match(/:(\w+)/gi);return s&&s.length>0&&s.forEach((s=>{const n=s.split(":")[1];t[n]&&(e=e.replace(s,t[n])),delete t[n]})),e})(e.url,e.data),e.isSendTraceId&&(e.header=Object.assign({"x-APM-TraceId":p(!0),"content-type":e.method===T.GET?"application/x-www-form-urlencoded":"application/json"},e.header)),e.timeout=this.timeout,e}}(e)}createApis(){const{options:e}=this,t={};return e.apiList.forEach((s=>{for(const n in s.apis){const i=s.apis[n];if(t[n])throw new Error("api name repeated, please check your api list");t[n]=async(t,o)=>{const r=Object.assign({},{method:i.method,url:s.baseUrl+i.path,data:t,header:{},isSendTraceId:e.isSendTraceId},o);this.lifecycle.triggerLifecycle({type:y.BEFORE_SEND,name:n,params:r});try{const e=await this.request.send(r);if(e.statusCode>=200&&e.statusCode<300)return this.lifecycle.triggerLifecycle({type:y.SUCCESS,name:n,params:r,result:e}),e.data;throw e}catch(e){throw await this.handleError({error:e,params:r,name:n}),e}}}})),t}async handleError({error:e,params:t,name:s}){const{lifecycle:n}=this,i=await wx.getNetworkType();e&&"request:fail"===e.errMsg&&"none"===i.networkType?n.triggerLifecycle({type:y.NETWORK_ERROR,name:s,params:t,error:e}):e&&"request:fail timeout"===e.errMsg?n.triggerLifecycle({type:y.TIMEOUT,name:s,params:t,error:e}):e.statusCode&&n.triggerLifecycle({type:y.REQUEST_ERROR,name:s,params:t,error:e})}}(s).createApis()})(I);this.rootModel=I,this.httpClient=t,await this.initSystem(),this.eventCenter.on(h,this.quitMeetingInside.bind(this))}async quitMeetingInside(){this.socket.io&&(await this.socket.closeMeetingSocket(),this.eventCenter.emit(q,{key:j.MEETING_END,data:{}}))}async initSystem(){this._system=new H({http:this.httpClient,model:this.rootModel}),await this._system.init()}get user(){return this._user||(this._user=new L({http:this.httpClient,model:this.rootModel})),this._user}get meeting(){return this._meeting||(this._meeting=new C({http:this.httpClient,model:this.rootModel})),this._meeting}get socket(){return this._socket||(this._socket=new P({http:this.httpClient,model:this.rootModel,eventCenter:this.eventCenter})),this._socket}get member(){return this._member||(this._member=new R({http:this.httpClient,model:this.rootModel})),this._member}get video(){return this._video||(this._video=new V({http:this.httpClient,model:this.rootModel})),this._video}get audio(){return this._audio||(this._audio=new b({http:this.httpClient,model:this.rootModel})),this._audio}get stream(){return this._stream||(this._stream=new B({http:this.httpClient,model:this.rootModel})),this._stream}async registerByPhoneCode(e){return await this.user.registerByPhoneCode(e)}async login(){return await this.user.login()}async joinMeeting(e){const t=await this.meeting.joinMeeting(e);return await this.socket.connectMeetingSocket(),await t}async quitMeeting(){return await this.socket.closeMeetingSocket(),this.eventCenter.off(q,null,!0),await this.meeting.quitMeeting()}async getMeetingInfo(){return await this.meeting.getMeetingInfo()}async getMemberList(e){return await this.member.getMeetingList(e)}async turnOnMicrophone(){return await this.audio.turnOnMicrophone()}async turnOffMicrophone(){return await this.audio.turnOffMicrophone()}async rejectTurnOnMicrophone(){return await this.audio.rejectTurnOnMicrophone()}async turnOnCamera(){return await this.video.turnOnCamera()}async turnOffCamera(){return await this.video.turnOffCamera()}async rejectTurnOnCamera(){return await this.video.rejectTurnOnCamera()}async getVideoPullUrl(e){return await this.stream.getVideoPullUrl(e)}async observeMember(e){return await this.stream.observeMember(e)}async unobserveMember(e){return await this.stream.unobserveMember(e)}onMessage(e){if("function"!=typeof e)throw new Error("onMessage params must be typeof function");this.eventCenter.on(q,(t=>{e&&e(t)}))}};module.exports=t})();